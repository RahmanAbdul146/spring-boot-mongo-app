node{
    
    def mavenHome= tool name: "maven" , type: "maven"
    def buildnumber = Build_Number
    
    stage('get code'){
        git branch: 'dev', credentialsId: 'GIT-Credentials', url: 'https://github.com/RahmanAbdul146/spring-boot-mongo-app.git'
    }
    
    stage('build package'){
        sh "${mavenHome}/bin/mvn clean package"
    }
    
    stage('build image'){
       // sh "aws ecr get-login-password --region ap-south-1 | docker login --username AWS --password-stdin 015901552966.dkr.ecr.ap-south-1.amazonaws.com"
        sh "docker build -t 015901552966.dkr.ecr.ap-south-1.amazonaws.com/springboot-app:${buildnumber} ."
    }
    
    stage('push image to ecr'){
        sh "docker push 015901552966.dkr.ecr.ap-south-1.amazonaws.com/springboot-app:${buildnumber}"
    }
    
    stage('deploy in k8s cluster'){
        sh "kubectl delete -f springapp.yaml"
        sh "kubectl apply -f springapp.yaml"
        sh "kubectl set image pod/springapppod  springappcontainer=015901552966.dkr.ecr.ap-south-1.amazonaws.com/springboot-app:${buildnumber}"
    }
}
